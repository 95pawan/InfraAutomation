node {
try{
    stage('Pull from SCM') {
            checkout scm
        } 

  
    stage("Build Container Image")
  {
  commit_id = sh(returnStdout: true, script: "git log -n 1 --pretty=format:'%h'").trim()
  
  sh "docker build -t terra.azurecr.io/demowsqc:${commit_id}  ."
  }
  
    stage("Push Image to Container Registry")
  {
withCredentials([
                [$class: 'UsernamePasswordMultiBinding', credentialsId: 'registryID', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD']
            ])  
                                                {
                                                                sh "docker login terra.azurecr.io -u '${env.USERNAME}' -p '${env.PASSWORD}'"
                                                }
                                                                sh "docker push terra.azurecr.io/demowsqc:${commit_id}"

  
  }
    stage("Pull and deploy container")
  {
  withDockerServer([credentialsId: 'dockerID', uri: 'terraformvm.westus2.cloudapp.azure.com'])
  {
   withCredentials([
                [$class: 'UsernamePasswordMultiBinding', credentialsId: 'registryID', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD']
            ])  
                                                {
                                                sh "docker login terra.azurecr.io -u '${env.USERNAME}' -p '${env.PASSWORD}'"
                                                }
sh "docker pull terra.azurecr.io/infraimage:${commit_id}"
sh "docker run -d -p 7060:8080 --name infrademo terra.azurecr.io/demowsqc:${commit_id}"
  }
  
  }

  
  }catch(err)
  {
  echo "${err}"
  }
}
